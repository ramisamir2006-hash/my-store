<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <title>Ù…ØªØ¬Ø± Ø±Ø§Ù…ÙŠ Ø³Ù…ÙŠØ±</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            direction: rtl; 
            padding: 20px; 
            background: #f0f2f5; 
            margin: 0;
            color: #333;
        }
        h2 { 
            text-align: center; 
            color: #0088cc; 
            margin-bottom: 30px; 
            font-size: 2em; 
        }
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            background: #fff; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
        }
        .product, .admin-section { 
            background: #f9f9f9; 
            padding: 15px; 
            margin-bottom: 12px; 
            border-radius: 8px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border: 1px solid #eee;
        }
        .product-info {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .product-name {
            font-weight: bold;
            font-size: 1.1em;
        }
        .product-price {
            color: #555;
            font-size: 0.9em;
        }
        button { 
            background: #0088cc; 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 0.95em;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #006bb3;
        }
        .cart-btn, .admin-submit-btn { 
            position: fixed; 
            bottom: 20px; 
            width: calc(100% - 40px); 
            left: 20px; 
            padding: 15px; 
            background: #28a745; 
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 163, 0, 0.3);
            max-width: 560px; /* Ù„ØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ container */
        }
        .cart-btn.hidden, .admin-panel.hidden {
            display: none;
        }
        .admin-panel {
            margin-top: 30px;
            border-top: 2px dashed #ccc;
            padding-top: 20px;
        }
        .admin-panel h3 {
            text-align: center;
            color: #d9534f;
            margin-bottom: 20px;
        }
        .admin-panel input[type="text"], 
        .admin-panel input[type="number"], 
        .admin-panel select {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        .admin-section button {
            background-color: #d9534f;
        }
        .admin-section button:hover {
            background-color: #c9302c;
        }
        .message {
            background-color: #e7f3fe;
            border-left: 6px solid #2196F3;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 4px;
            font-size: 0.9em;
            text-align: right;
        }
        #cartSummary {
            margin-top: 20px;
            padding: 15px;
            background-color: #e6f7ff;
            border: 1px solid #91d5ff;
            border-radius: 8px;
            font-size: 1em;
        }
        #cartSummary h4 {
            margin-top: 0;
            color: #0056b3;
        }
        #cartSummary ul {
            list-style: none;
            padding: 0;
        }
        #cartSummary ul li {
            padding: 5px 0;
            border-bottom: 1px dashed #cce0ff;
        }
        #cartSummary ul li:last-child {
            border-bottom: none;
        }
        .total-price {
            font-weight: bold;
            color: #007bff;
            margin-top: 10px;
            text-align: left;
        }
        .remove-from-cart {
            background-color: #ffc107;
            color: #333;
            padding: 5px 8px;
            font-size: 0.8em;
            margin-right: 5px;
        }
        .remove-from-cart:hover {
            background-color: #e0a800;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 id="pageTitle">ğŸ›ï¸ Ù…ØªØ¬Ø± Ø±Ø§Ù…ÙŠ Ø³Ù…ÙŠØ±</h2>

        <div id="customerView">
            <div id="productsList">
                <div class="message">
                    Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ….
                </div>
            </div>
            
            <div id="cartSummary" class="hidden">
                <h4>Ø³Ù„Ø© Ù…Ø´ØªØ±ÙŠØ§ØªÙƒ:</h4>
                <ul id="cartItemsList">
                    </ul>
                <div class="total-price">
                    Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="cartTotalPrice">0</span> Ø¬.Ù…
                </div>
            </div>
            
            <button class="cart-btn" id="sendOrderBtn" onclick="sendOrder()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø¨ÙˆØª âœ…</button>
        </div>

        <div id="adminPanel" class="admin-panel hidden">
            <h3>âš™ï¸ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±</h3>
            
            <div class="admin-section">
                <h4>â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h4>
                <input type="text" id="newProductName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" required>
                <input type="number" id="newProductPrice" placeholder="Ø§Ù„Ø³Ø¹Ø±" required>
                <select id="newProductCategory">
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>
                    </select>
                <button onclick="addProduct()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬</button>
            </div>

            <div class="admin-section">
                <h4>ğŸ“‚ Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯</h4>
                <input type="text" id="newCategoryName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…" required>
                <button onclick="addCategory()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù…</button>
            </div>

            <div class="admin-section">
                <h4>ğŸ—‘ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h4>
                <ul id="manageProductsList">
                    </ul>
            </div>
             <button class="admin-submit-btn" onclick="saveAdminChanges()">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ğŸ’¾</button>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand(); 
        
        let cart = [];
        let products = JSON.parse(localStorage.getItem('storeProducts')) || [];
        let categories = JSON.parse(localStorage.getItem('storeCategories')) || ['Ø£Ø³Ø§ÙˆØ±', 'Ø®ÙˆØ§ØªÙ…', 'Ø³Ù„Ø§Ø³Ù„'];

        const urlParams = new URLSearchParams(window.location.search);
        const isAdmin = urlParams.get('admin') === 'true';

        // Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± Ø£Ùˆ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„
        if (isAdmin) {
            document.getElementById('customerView').classList.add('hidden');
            document.getElementById('sendOrderBtn').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
            document.getElementById('pageTitle').innerText = "âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ù…ØªØ¬Ø± Ø±Ø§Ù…ÙŠ Ø³Ù…ÙŠØ±";
            renderAdminPanel();
        } else {
            document.getElementById('adminPanel').classList.add('hidden');
            renderProducts();
        }

        function saveState() {
            localStorage.setItem('storeProducts', JSON.stringify(products));
            localStorage.setItem('storeCategories', JSON.stringify(categories));
            renderProducts();
            if (isAdmin) renderAdminPanel();
        }

        // --- ÙˆØ¸Ø§Ø¦Ù Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Ù„Ù„Ù…Ø¯ÙŠØ±) ---
        function renderAdminPanel() {
            // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬
            const categorySelect = document.getElementById('newProductCategory');
            categorySelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.innerText = cat;
                categorySelect.appendChild(option);
            });

            // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ù„Ù„Ø­Ø°Ù)
            const manageProductsList = document.getElementById('manageProductsList');
            manageProductsList.innerHTML = '';
            if (products.length === 0) {
                manageProductsList.innerHTML = '<li>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¹Ø¯.</li>';
                return;
            }
            products.forEach((product, index) => {
                const li = document.createElement('li');
                li.innerHTML = `${product.name} (${product.price} Ø¬.Ù…) <button class="remove-from-cart" onclick="deleteProduct(${index})">Ø­Ø°Ù</button>`;
                manageProductsList.appendChild(li);
            });
        }

        function addProduct() {
            const name = document.getElementById('newProductName').value;
            const price = parseFloat(document.getElementById('newProductPrice').value);
            const category = document.getElementById('newProductCategory').value;

            if (name && price > 0 && category) {
                products.push({ name, price, category });
                document.getElementById('newProductName').value = '';
                document.getElementById('newProductPrice').value = '';
                document.getElementById('newProductCategory').value = '';
                saveState();
                tg.showPopup({message: `ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬: ${name}`});
            } else {
                tg.showAlert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ÙˆØ³Ø¹Ø± ÙˆÙ‚Ø³Ù… ØµØ­ÙŠØ­ Ù„Ù„Ù…Ù†ØªØ¬.");
            }
        }

        function deleteProduct(index) {
            const productName = products[index].name;
            products.splice(index, 1);
            saveState();
            tg.showPopup({message: `ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬: ${productName}`});
        }

        function addCategory() {
            const name = document.getElementById('newCategoryName').value;
            if (name && !categories.includes(name)) {
                categories.push(name);
                document.getElementById('newCategoryName').value = '';
                saveState();
                tg.showPopup({message: `ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù…: ${name}`});
            } else if (categories.includes(name)) {
                tg.showAlert("Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„.");
            } else {
                tg.showAlert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù….");
            }
        }

        function saveAdminChanges() {
             // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù„Ù„Ø¨ÙˆØª Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ø­ÙØ¸Ù‡Ø§ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±ÙƒØ²ÙŠØ©
             // tg.sendData(JSON.stringify({ type: 'admin_update', products: products, categories: categories }));
             tg.showPopup({message: "ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¨Ù†Ø¬Ø§Ø­!"});
             // ÙŠÙ…ÙƒÙ† Ù‡Ù†Ø§ Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø¯ÙŠØ± Ù„ØµÙØ­Ø© Ø£Ø®Ø±Ù‰ Ø£Ùˆ Ù…Ø¬Ø±Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        }


        // --- ÙˆØ¸Ø§Ø¦Ù Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ø¹Ù…ÙŠÙ„ ---
        function renderProducts() {
            const productsList = document.getElementById('productsList');
            productsList.innerHTML = ''; // ØªÙØ±ÙŠØº Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶

            if (products.length === 0) {
                productsList.innerHTML = '<div class="message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…ØªÙˆÙØ±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</div>';
                return;
            }

            products.forEach(product => {
                const productDiv = document.createElement('div');
                productDiv.className = 'product';
                productDiv.innerHTML = `
                    <div class="product-info">
                        <span class="product-name">${product.name}</span>
                        <span class="product-price">${product.price} Ø¬.Ù…</span>
                    </div>
                    <button onclick="addToCart('${product.name}', ${product.price})">Ø¥Ø¶Ø§ÙØ© +</button>
                `;
                productsList.appendChild(productDiv);
            });
        }

        function addToCart(name, price) {
            cart.push({name, price});
            tg.showPopup({message: `ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© "${name}" Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©`});
            updateCartSummary();
        }

        function removeFromCart(index) {
            const removedItem = cart.splice(index, 1);
            tg.showPopup({message: `ØªÙ… Ø­Ø°Ù "${removedItem[0].name}" Ù…Ù† Ø§Ù„Ø³Ù„Ø©`});
            updateCartSummary();
        }

        function updateCartSummary() {
            const cartSummary = document.getElementById('cartSummary');
            const cartItemsList = document.getElementById('cartItemsList');
            const cartTotalPrice = document.getElementById('cartTotalPrice');

            if (cart.length === 0) {
                cartSummary.classList.add('hidden');
                return;
            }

            cartSummary.classList.remove('hidden');
            cartItemsList.innerHTML = '';
            let total = 0;

            cart.forEach((item, index) => {
                const li = document.createElement('li');
                li.innerHTML = `${item.name} - ${item.price} Ø¬.Ù… <button class="remove-from-cart" onclick="removeFromCart(${index})">Ø¥Ø²Ø§Ù„Ø©</button>`;
                cartItemsList.appendChild(li);
                total += item.price;
            });
            cartTotalPrice.innerText = total;
        }

        function sendOrder() {
            if (cart.length === 0) {
                tg.showAlert("Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙØ§Ø±ØºØ©!");
                return;
            }
            let data = {
                items: cart,
                total: cart.reduce((sum, item) => sum + item.price, 0),
                user_id: tg.initDataUnsafe.user.id // ÙŠØ±Ø³Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø¨ÙˆØª
            };
            tg.sendData(JSON.stringify(data)); // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¨ÙˆØª
            cart = []; // Ø¥ÙØ±Ø§Øº Ø§Ù„Ø³Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
            updateCartSummary();
            tg.close(); // Ø¥ØºÙ„Ø§Ù‚ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙˆÙŠØ¨ Ø¨Ø¹Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ù„Ø© Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
        updateCartSummary();

    </script>
</body>
</html>
